---
title: "Quick reference for nicheApport package usage"
author: Mario J. Marques-Azevedo
date: "November 28, 2017"
output: rmarkdown::pdf_document
papersize: a4
documentclass: article
linestretch: 1.3
geometry: left=4cm, right=4cm, top=2cm, bottom=2cm
vignette: >
  %\VignetteIndexEntry{Quick reference for nicheApport package usage}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
bibliography: nicheApport.bib
csl: oikos.csl
---
<!--\bibliography{nicheApport.bib}-->

```{r, include=FALSE}
library(nicheApport)
options(width = 60)
```

#Introduction

Species abundance distribution (SAD) is one of the basic description of ecological communities data [@mcgill_species_2007]. One way to represent the distribution of species abundance is to plot the ranked abundances from highest to lowest on x-axis and the abundance on y-axis (known too as MacArthur plot). Niche apportionment models were proposed to be a biological model to describe SAD [@tokeshi_niche_1990; @tokeshi_power_1996; @matthews_fitting_2014]. This models assume that total niche are sequentially divided between species [@tokeshi_niche_1990; @matthews_fitting_2014]. There are proposed procedures to fit niche apportionment model to data [@tokeshi_niche_1990; @bersier_species_1997; @cassey_problem_2001; @mouillot_how_2003], but no one open source tool to do this. This package simulate species rank abundance distributions (RAD) and use Monte Carlo approach, proposed by @bersier_species_1997, @cassey_problem_2001, @mouillot_how_2003 to fit model to replicated data.


#Installation

The package can be installed using _devtools_ package on R. For a stable version use the _master_ branch

```{r install-master, eval=FALSE}
library(devtools)
install_github(repo = "mariojose/nicheApport", ref = "master")
```

or for a development version a _dev_ branch.

```{r install-dev, eval=FALSE}
library(devtools)
install_github(repo = "mariojose/nicheApport", ref = "dev")
```


#Models

The _nicheApport_ package simulate the six models proposed by @tokeshi_niche_1990,tokeshi_power_1996: Dominance Decay, Dominance Preemption, MacArthur Fraction, Random Fraction, Random Assortment and Power Fraction.

Before start simulation, load the package,

```{r load-library, message=FALSE}
library(nicheApport)
```

then simulate the Random Fraction model with 10 species and total abundance of 150 individuals.

```{r randFraction}
set.seed(42)
randFraction(N = 150, S = 10, count = TRUE)
```

Note that in this run the last rank has no individual. This can happen when using counts, mainly if you choose a model with high dominance like Dominance Preemption model.

The Power Fraction model differ from other model by the _w_ parameter. It weight niche portion by its abundance when procedure select fraction to divide in two new. The follow simulation run with 10 species, 300 kg of biomass (abundance) and _w_ equal to 0.2.

```{r powerFraction}
powerFraction(N = 300, S = 10, w = 0.2)
```

#Fitting

Models can be fitted to data using _fitmodel_ or _fitmodelCl_ functions. The last one run the fitting procedure using parallel computation. An abstract data will be created to exemplifying the fitting. This data will have 30 species, 10 replicates and total abundance at each replicates 500 kg of biomass. Replicates represents samples in a site, for instance.

```{r create-data}
data <- matrix(nrow = 10, ncol = 30)
for(i in 1:dim(data)[1]){
  data[i, ] <- randFraction(N = 500, S = 30, count = FALSE)
}
```

Now, run the fitting function and show the result of fitting (for Random Fraction and MacArthur Fraction models).

```{r fitmodel}
m1 <- fitmodel(x = data, model = "randFraction", 
               count = FALSE, nRand = 99)
m2 <- fitmodel(x = data, model = "MacArthurFraction", 
               count = FALSE, nRand = 99)

m1
m2
```

When you inform the name of object, a summary of simulations is shown. _nicheAppot_ use S4 object system. This means that to get values from object you can use '@' instead '$'. The object _m1_ and _m2_ are _fitmodel_ objects. To get the name of variables (slots) of _fitmodel_ object you can use _getSlots_. You can know more about _fitmodel_ slots in _fitmodel_ or _fitmodelCl_ functions help.

```{r getSlots}
getSlots('fitmodel')

# Printing stats for simulated data for Random Fraction simulation
m1@sim.stats
```

#Plotting

The rank abundance can be plotted using function _plot_. It will plots the observed logarithm at base 2, for instance, of the mean of each rank for all replicates. To add the simulated line of the models use function _lines_. The _range_ parameter will plot minimum and maximum of the simulated values.

```{r plot, fig.height=5, fig.width=5, fig.align="center"}
plot(m1, stat = "mean", base = 2)

lines(m1, stat = "mean", base = 2, range = TRUE, col = "blue")
lines(m2, stat = "mean", base = 2, range = TRUE, col = "red")

legend("topright", lty = 1, col = c("blue", "red"), bty = "n",
       legend = c("Random Fraction", "MacArthur Fraction"))
```

You can confirm which rank is within simulation checking previous plot or use _qqplot_ function. It will plot the simulated abundance against observed abundances highlighting the observed values out of simulated abundances (grey colour).

```{r qqplot, fig.height=5, fig.width=10, fig.align="center"}
par(mfrow = c(1,2))
qqplot(m1, stat = "mean", base = 2, range = TRUE, 
       main = "Random Fraction")
qqplot(m2, stat = "mean", base = 2, range = TRUE, 
       main = "MacArthur Fraction")
```

The fitting procedure calculate the _T_ statistics to confirm if model fit to data. To plot the simulated values of _T_ use the function _hist_.

```{r hist, fig.height=5, fig.width=10, fig.align="center"}
par(mfrow = c(1,2))
hist(m1, stat = "mean", arrow.col = "blue", 
     main = "Random Fraction")
hist(m2, stat = "variance", arrow.col = "blue", 
     main = "MacArthur Fraction")
```

#Reporting bugs

The package project is hosted on GitHub (https://github.com/mariojose/nicheApport/) and bugs can be reported in issue section (https://github.com/mariojose/nicheApport/issues). Your feedback is very important.

#Bibliography

